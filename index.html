<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Expense Tracker</title>

  <!-- Chart library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .app {
      width: 100%;
      max-width: 900px;
      background: #020617;
      padding: 20px;
      border-radius: 16px;
      border: 1px solid #1f2937;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    h1 {
      margin: 0 0 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 22px;
    }

    h1 small {
      font-size: 12px;
      opacity: 0.7;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }

    .card {
      background: #020617;
      border: 1px solid #1e293b;
      border-radius: 12px;
      padding: 12px 14px;
    }

    .card h4 {
      margin: 0 0 4px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.7;
    }

    .card p {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .chart-card canvas {
      max-height: 260px;
    }

    form {
      margin-top: 15px;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
      gap: 10px;
    }

    input, select, button {
      padding: 8px 10px;
      border-radius: 8px;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #1e293b;
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.4);
    }

    button {
      background: #6366f1;
      cursor: pointer;
      font-weight: 600;
      border: none;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s;
    }

    button:hover {
      background: #4f46e5;
      box-shadow: 0 6px 14px rgba(79, 70, 229, 0.5);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .filters {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .filters select {
      min-width: 130px;
    }

    .filters button {
      padding-inline: 14px;
    }

    .transactions {
      margin-top: 20px;
      border-radius: 12px;
      border: 1px solid #1e293b;
      overflow: hidden;
    }

    .row {
      display: grid;
      grid-template-columns: 2fr 1fr 1.3fr 1fr auto;
      padding: 8px 10px;
      border-bottom: 1px solid #1e293b;
      font-size: 14px;
      align-items: center;
    }

    .row:nth-child(odd) {
      background: #020617;
    }

    .row:nth-child(even) {
      background: #030712;
    }

    .actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }

    .delete {
      background: #dc2626;
      border: none;
      color: white;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 12px;
    }

    .edit {
      background: #0ea5e9;
      border: none;
      color: white;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 12px;
    }

    .income { color: #22c55e; }
    .expense { color: #f97316; }

    .empty {
      padding: 12px;
      text-align: center;
      font-size: 13px;
      opacity: 0.7;
    }

    @media (max-width: 700px) {
      .summary {
        grid-template-columns: 1fr;
      }

      .card.chart-card {
        grid-column: span 1 !important;
      }

      form {
        grid-template-columns: 1fr 1fr;
      }

      form button {
        grid-column: span 2;
      }

      .row {
        grid-template-columns: 1.5fr 1fr 1.3fr 1fr auto;
      }

      .filters {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>

<div class="app">
  <h1>
    Expense Tracker
    <small>Edit + Category chart + Filters + Export</small>
  </h1>

  <div class="summary">
    <div class="card">
      <h4>Balance</h4>
      <p id="balance">€0.00</p>
    </div>
    <div class="card">
      <h4>Income</h4>
      <p id="income" class="income">€0.00</p>
    </div>
    <div class="card">
      <h4>Expense</h4>
      <p id="expense" class="expense">€0.00</p>
    </div>
    <div class="card">
      <h4>Top spending category</h4>
      <p id="top-category">-</p>
    </div>

    <div class="card chart-card" style="grid-column: span 4;">
      <h4>Expense by category</h4>
      <canvas id="chart"></canvas>
    </div>
  </div>

  <!-- Add / Edit transaction form -->
  <form id="form">
    <input id="desc" placeholder="Description (e.g. Groceries)" required />
    <input id="amount" type="number" step="0.01" placeholder="Amount" required />
    <select id="type">
      <option value="income">Income</option>
      <option value="expense">Expense</option>
    </select>
    <select id="category">
      <option value="Food">Food</option>
      <option value="Rent">Rent</option>
      <option value="Shopping">Shopping</option>
      <option value="Transport">Transport</option>
      <option value="Bills">Bills</option>
      <option value="Entertainment">Entertainment</option>
      <option value="Salary">Salary</option>
      <option value="Other">Other</option>
    </select>
    <input type="date" id="date" />
    <button type="submit" id="submit-btn">Add</button>
  </form>

  <!-- Filters -->
  <div class="filters">
    <select id="filter-month">
      <option value="">All Months</option>
      <option value="01">January</option>
      <option value="02">February</option>
      <option value="03">March</option>
      <option value="04">April</option>
      <option value="05">May</option>
      <option value="06">June</option>
      <option value="07">July</option>
      <option value="08">August</option>
      <option value="09">September</option>
      <option value="10">October</option>
      <option value="11">November</option>
      <option value="12">December</option>
    </select>

    <select id="filter-year">
      <option value="">All Years</option>
      <option value="2023">2023</option>
      <option value="2024">2024</option>
      <option value="2025">2025</option>
      <option value="2026">2026</option>
    </select>

    <button id="apply-filters">Apply filters</button>
    <button id="clear-filters" type="button">Clear filters</button>
    <button id="export-csv" type="button">Export CSV</button>
  </div>

  <!-- Transactions list -->
  <div class="transactions" id="list"></div>
</div>

<script>
  // Data + state
  let transactions = JSON.parse(localStorage.getItem("data") || "[]");
  let chart;
  let currentMonth = "";
  let currentYear = "";
  let editingId = null; // null = add mode, not editing

  // Elements
  const form = document.getElementById("form");
  const list = document.getElementById("list");
  const balanceEl = document.getElementById("balance");
  const incomeEl = document.getElementById("income");
  const expenseEl = document.getElementById("expense");
  const topCategoryEl = document.getElementById("top-category");
  const dateInput = document.getElementById("date");
  const filterMonthEl = document.getElementById("filter-month");
  const filterYearEl = document.getElementById("filter-year");
  const applyFiltersBtn = document.getElementById("apply-filters");
  const clearFiltersBtn = document.getElementById("clear-filters");
  const exportCsvBtn = document.getElementById("export-csv");
  const submitBtn = document.getElementById("submit-btn");

  const descInput = document.getElementById("desc");
  const amountInput = document.getElementById("amount");
  const typeInput = document.getElementById("type");
  const categoryInput = document.getElementById("category");

  // Default date = today
  dateInput.valueAsNumber =
    Date.now() - new Date().getTimezoneOffset() * 60000;

  // Helpers
  function save() {
    localStorage.setItem("data", JSON.stringify(transactions));
  }

  function format(val) {
    return "€" + val.toFixed(2);
  }

  function getFilteredTransactions() {
    return transactions.filter((t) => {
      const dateStr = t.date || "";
      const [year, month] = dateStr.split("-"); // yyyy-mm-dd

      if (currentMonth && month !== currentMonth) return false;
      if (currentYear && year !== currentYear) return false;

      return true;
    });
  }

  // Summary (depends on filtered data)
  function renderSummary(data) {
    let income = 0;
    let expense = 0;
    const categoryTotals = {};

    data.forEach((t) => {
      const cat = t.category || "Other";
      if (t.type === "income") {
        income += t.amount;
      } else {
        expense += t.amount;
        categoryTotals[cat] = (categoryTotals[cat] || 0) + t.amount;
      }
    });

    balanceEl.textContent = format(income - expense);
    incomeEl.textContent = format(income);
    expenseEl.textContent = format(expense);

    // Top spending category (from expenses only)
    const cats = Object.keys(categoryTotals);
    if (cats.length === 0) {
      topCategoryEl.textContent = "-";
    } else {
      let topCat = cats[0];
      cats.forEach((c) => {
        if (categoryTotals[c] > categoryTotals[topCat]) {
          topCat = c;
        }
      });
      topCategoryEl.textContent =
        `${topCat} (${format(categoryTotals[topCat])})`;
    }

    renderChart(categoryTotals);
  }

  // Chart – Expense by category (different colors)
  function renderChart(categoryTotals) {
    const ctx = document.getElementById("chart").getContext("2d");

    const labels = Object.keys(categoryTotals);
    const values = labels.map((l) => categoryTotals[l]);

    if (chart) chart.destroy();

    // If no expense data, show a neutral chart
    if (labels.length === 0) {
      chart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["No expense data"],
          datasets: [{
            data: [1],
            backgroundColor: ["#4b5563"]
          }]
        },
        options: {
          plugins: {
            legend: { labels: { color: "#e5e7eb" } }
          }
        }
      });
      return;
    }

    const baseColors = [
      "#22c55e", // green
      "#f97316", // orange
      "#3b82f6", // blue
      "#a855f7", // purple
      "#eab308", // yellow
      "#06b6d4", // teal
      "#f43f5e", // pink/red
      "#10b981", // emerald
    ];

    const colors = labels.map((_, i) => baseColors[i % baseColors.length]);

    chart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels,
        datasets: [
          {
            data: values,
            backgroundColor: colors,
          },
        ],
      },
      options: {
        plugins: {
          legend: { labels: { color: "#e5e7eb" } }
        }
      }
    });
  }

  // List (depends on filtered data)
  function renderList(data) {
    list.innerHTML = "";

    if (data.length === 0) {
      const empty = document.createElement("div");
      empty.className = "empty";
      empty.textContent =
        "No transactions for this filter. Add one above or clear filters.";
      list.appendChild(empty);
      return;
    }

    data.forEach((t) => {
      const row = document.createElement("div");
      row.className = "row";

      const categoryLabel = t.category || "Other";

      row.innerHTML = `
        <div>${t.desc}</div>
        <div class="${t.type}">${format(t.amount)}</div>
        <div>${t.type} (${categoryLabel})</div>
        <div>${t.date || "-"}</div>
        <div class="actions">
          <button class="edit">Edit</button>
          <button class="delete">X</button>
        </div>
      `;

      const editBtn = row.querySelector(".edit");
      const deleteBtn = row.querySelector(".delete");

      deleteBtn.onclick = () => {
        transactions = transactions.filter((x) => x.id !== t.id);
        // If you delete the one you're editing, reset form mode
        if (editingId === t.id) {
          resetFormMode();
        }
        save();
        render();
      };

      editBtn.onclick = () => {
        // Set edit mode
        editingId = t.id;

        descInput.value = t.desc;
        amountInput.value = t.amount;
        typeInput.value = t.type;
        categoryInput.value = t.category || "Other";
        dateInput.value = t.date || new Date().toISOString().slice(0, 10);

        submitBtn.textContent = "Save changes";
        submitBtn.style.background = "#22c55e";
        submitBtn.style.boxShadow = "0 6px 14px rgba(34,197,94,0.5)";

        // Scroll to top of form (mobile friendly)
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      list.appendChild(row);
    });
  }

  // Main render
  function render() {
    const data = getFilteredTransactions();
    renderSummary(data);
    renderList(data);
  }

  function resetFormMode() {
    editingId = null;
    form.reset();
    // reset date to today
    dateInput.valueAsNumber =
      Date.now() - new Date().getTimezoneOffset() * 60000;
    submitBtn.textContent = "Add";
    submitBtn.style.background = "#6366f1";
    submitBtn.style.boxShadow = "none";
  }

  // Form submit (Add or Edit)
  form.onsubmit = (e) => {
    e.preventDefault();

    const amountVal = parseFloat(amountInput.value);

    if (!descInput.value.trim() || isNaN(amountVal) || amountVal <= 0) {
      alert("Please enter a valid description and positive amount.");
      return;
    }

    const payload = {
      desc: descInput.value.trim(),
      amount: amountVal,
      type: typeInput.value,
      category: categoryInput.value || "Other",
      date:
        dateInput.value || new Date().toISOString().slice(0, 10),
    };

    if (editingId === null) {
      // ADD MODE
      const t = {
        id: Date.now(),
        ...payload,
      };
      transactions.unshift(t);
    } else {
      // EDIT MODE
      const index = transactions.findIndex((x) => x.id === editingId);
      if (index !== -1) {
        transactions[index] = { ...transactions[index], ...payload };
      }
    }

    save();
    render();
    resetFormMode();
  };

  // Filters
  applyFiltersBtn.onclick = (e) => {
    e.preventDefault();
    currentMonth = filterMonthEl.value;
    currentYear = filterYearEl.value;
    render();
  };

  clearFiltersBtn.onclick = () => {
    currentMonth = "";
    currentYear = "";
    filterMonthEl.value = "";
    filterYearEl.value = "";
    render();
  };

  // Export CSV (filtered data)
  exportCsvBtn.onclick = () => {
    const data = getFilteredTransactions();
    if (data.length === 0) {
      alert("No transactions to export for this filter.");
      return;
    }

    const header = ["Description", "Amount", "Type", "Category", "Date"];
    const rows = data.map((t) => [
      t.desc,
      t.amount,
      t.type,
      t.category || "Other",
      t.date || "",
    ]);

    const csvLines = [header, ...rows]
      .map((row) =>
        row
          .map((value) => {
            const str = String(value ?? "");
            if (str.includes(",") || str.includes('"')) {
              return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
          })
          .join(",")
      )
      .join("\n");

    const blob = new Blob([csvLines], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    const today = new Date().toISOString().slice(0, 10);
    link.href = url;
    link.download = `expenses-${today}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    URL.revokeObjectURL(url);
  };

  // Initial render
  render();
</script>

</body>
</html>
